#!/bin/bash
# claude-workflow - Common development workflow automations
# Reduces repetitive task overhead for voice-controlled development

set -euo pipefail

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

usage() {
    cat <<EOF
${BLUE}claude-workflow${NC} - Development Workflow Automations

Usage:
  claude-workflow <command> [options]

Commands:
  ${GREEN}status${NC}           Show comprehensive project status
  ${GREEN}commit${NC}           Interactive git commit helper
  ${GREEN}sync${NC}             Pull latest, rebase if needed
  ${GREEN}test-fix${NC}         Run tests in loop until passing
  ${GREEN}build-check${NC}      Build and report any errors
  ${GREEN}quick-push${NC}       Add, commit, push in one go
  ${GREEN}project-health${NC}   Full project health check

Examples:
  claude-workflow status
  claude-workflow test-fix
  claude-workflow quick-push "fix: typo in README"

${CYAN}Tip: These commands are optimized for voice control${NC}

EOF
    exit 0
}

# Status - comprehensive project overview
cmd_status() {
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo -e "${BOLD}${BLUE}Project Status${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo ""

    # Git status
    if [[ -d .git ]]; then
        echo -e "${GREEN}Git Status:${NC}"
        git status --short --branch
        echo ""

        echo -e "${GREEN}Recent Commits:${NC}"
        git log --oneline -5
        echo ""
    fi

    # Check for common files
    echo -e "${GREEN}Project Files:${NC}"
    [[ -f README.md ]] && echo -e "  ${GREEN}✓${NC} README.md"
    [[ -f CLAUDE.md ]] && echo -e "  ${GREEN}✓${NC} CLAUDE.md"
    [[ -f pyproject.toml ]] && echo -e "  ${GREEN}✓${NC} pyproject.toml (Python)"
    [[ -f package.json ]] && echo -e "  ${GREEN}✓${NC} package.json (Node)"
    echo ""

    # Virtual environment
    if [[ -n "${VIRTUAL_ENV:-}" ]]; then
        echo -e "${GREEN}Python Environment:${NC}"
        echo -e "  Active: $(basename "$VIRTUAL_ENV")"
        python --version 2>&1
        echo ""
    fi
}

# Commit - interactive git commit
cmd_commit() {
    echo -e "${BLUE}Interactive Git Commit${NC}"
    echo ""

    # Show status
    git status --short

    echo ""
    echo -ne "${YELLOW}Stage all changes? (y/N):${NC} "
    read -r stage_all

    if [[ "$stage_all" =~ ^[Yy]$ ]]; then
        git add -A
        echo -e "${GREEN}✓ Staged all changes${NC}"
    else
        echo -e "${YELLOW}Use 'git add' to stage specific files${NC}"
        return
    fi

    echo ""
    echo -e "${BLUE}Commit message:${NC}"
    echo -e "${CYAN}(Use voice dictation)${NC}"
    echo -ne "> "
    read -r commit_msg

    if [[ -z "$commit_msg" ]]; then
        echo -e "${RED}Commit cancelled - no message${NC}"
        return 1
    fi

    git commit -m "$commit_msg"
    echo -e "${GREEN}✓ Committed${NC}"

    echo ""
    echo -ne "${YELLOW}Push to remote? (y/N):${NC} "
    read -r do_push

    if [[ "$do_push" =~ ^[Yy]$ ]]; then
        git push
        echo -e "${GREEN}✓ Pushed${NC}"
    fi
}

# Sync - pull and update
cmd_sync() {
    echo -e "${BLUE}Syncing with remote...${NC}"

    if [[ ! -d .git ]]; then
        echo -e "${RED}Not a git repository${NC}"
        return 1
    fi

    local branch=$(git branch --show-current)
    echo -e "Branch: ${CYAN}${branch}${NC}"

    git fetch origin
    git pull --rebase origin "$branch"

    echo -e "${GREEN}✓ Synced${NC}"
}

# Test-Fix - run tests until passing
cmd_test_fix() {
    echo -e "${BLUE}Running tests in fix mode...${NC}"
    echo -e "${YELLOW}Will loop until tests pass${NC}"
    echo ""

    local attempt=1
    local max_attempts=10

    while [[ $attempt -le $max_attempts ]]; do
        echo -e "${CYAN}Attempt $attempt/$max_attempts${NC}"

        # Detect test command
        local test_cmd=""
        if [[ -f pyproject.toml ]] && /usr/bin/grep -q "pytest" pyproject.toml; then
            test_cmd="pytest"
        elif [[ -f package.json ]] && /usr/bin/grep -q "\"test\"" package.json; then
            test_cmd="npm test"
        elif [[ -f Makefile ]] && /usr/bin/grep -q "^test:" Makefile; then
            test_cmd="make test"
        else
            echo -e "${YELLOW}No test command detected. Specify manually:${NC}"
            echo -ne "> "
            read -r test_cmd
        fi

        if $test_cmd; then
            echo -e "${GREEN}✓ Tests passed!${NC}"
            return 0
        else
            echo -e "${RED}Tests failed${NC}"
            echo ""
            echo -ne "${YELLOW}Fix and press Enter to retry (or Ctrl-C to quit):${NC} "
            read -r
        fi

        attempt=$((attempt + 1))
    done

    echo -e "${RED}Max attempts reached${NC}"
    return 1
}

# Build-Check - build and report
cmd_build_check() {
    echo -e "${BLUE}Building project...${NC}"

    local build_cmd=""

    # Detect build command
    if [[ -f pyproject.toml ]]; then
        build_cmd="uv build"
    elif [[ -f package.json ]]; then
        build_cmd="npm run build"
    elif [[ -f Makefile ]] && /usr/bin/grep -q "^build:" Makefile; then
        build_cmd="make build"
    else
        echo -e "${YELLOW}No build command detected. Specify manually:${NC}"
        echo -ne "> "
        read -r build_cmd
    fi

    if $build_cmd 2>&1 | tee /tmp/build-output.txt; then
        echo ""
        echo -e "${GREEN}✓ Build successful${NC}"
    else
        echo ""
        echo -e "${RED}✗ Build failed${NC}"
        echo ""
        echo -e "${YELLOW}Errors:${NC}"
        /usr/bin/grep -i "error" /tmp/build-output.txt || echo "See full output above"
        return 1
    fi
}

# Quick-Push - add, commit, push in one go
cmd_quick_push() {
    local message="${1:-}"

    if [[ -z "$message" ]]; then
        echo -e "${BLUE}Quick commit and push${NC}"
        echo -e "${CYAN}(Use voice dictation for commit message)${NC}"
        echo -ne "${YELLOW}Commit message:${NC} "
        read -r message
    fi

    if [[ -z "$message" ]]; then
        echo -e "${RED}No commit message provided${NC}"
        return 1
    fi

    echo -e "${BLUE}Staging all changes...${NC}"
    git add -A

    echo -e "${BLUE}Committing...${NC}"
    git commit -m "$message"

    echo -e "${BLUE}Pushing...${NC}"
    git push

    echo -e "${GREEN}✓ Done${NC}"
}

# Project-Health - comprehensive health check
cmd_project_health() {
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo -e "${BOLD}${BLUE}Project Health Check${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo ""

    local issues=0

    # Git checks
    echo -e "${GREEN}Git:${NC}"
    if [[ -d .git ]]; then
        local uncommitted=$(git status --short | wc -l | tr -d ' ')
        if [[ "$uncommitted" -gt 0 ]]; then
            echo -e "  ${YELLOW}!${NC} $uncommitted uncommitted changes"
            issues=$((issues + 1))
        else
            echo -e "  ${GREEN}✓${NC} Clean working tree"
        fi

        local unpushed=$(git log --oneline @{u}.. 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$unpushed" -gt 0 ]]; then
            echo -e "  ${YELLOW}!${NC} $unpushed unpushed commits"
            issues=$((issues + 1))
        else
            echo -e "  ${GREEN}✓${NC} Up to date with remote"
        fi
    else
        echo -e "  ${YELLOW}!${NC} Not a git repository"
        issues=$((issues + 1))
    fi

    echo ""

    # Documentation checks
    echo -e "${GREEN}Documentation:${NC}"
    [[ -f README.md ]] && echo -e "  ${GREEN}✓${NC} README.md" || { echo -e "  ${YELLOW}!${NC} No README.md"; issues=$((issues + 1)); }
    [[ -f CLAUDE.md ]] && echo -e "  ${GREEN}✓${NC} CLAUDE.md" || echo -e "  ${CYAN}•${NC} No CLAUDE.md (optional)"

    echo ""

    # Summary
    echo -e "${BLUE}─────────────────────────────────────────────${NC}"
    if [[ $issues -eq 0 ]]; then
        echo -e "${GREEN}✓ Project health: GOOD${NC}"
    else
        echo -e "${YELLOW}! Project health: $issues issue(s)${NC}"
    fi
    echo ""
}

# Main dispatcher
CMD="${1:-}"

case "$CMD" in
    status)
        cmd_status
        ;;
    commit)
        cmd_commit
        ;;
    sync)
        cmd_sync
        ;;
    test-fix)
        cmd_test_fix
        ;;
    build-check)
        cmd_build_check
        ;;
    quick-push)
        cmd_quick_push "${2:-}"
        ;;
    project-health)
        cmd_project_health
        ;;
    --help|-h|help|"")
        usage
        ;;
    *)
        echo -e "${RED}Unknown command: $CMD${NC}"
        echo ""
        usage
        ;;
esac
