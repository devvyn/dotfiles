#!/bin/bash
# claude-status - One-screen dashboard for Claude Code workspace
# Shows: projects, bridge messages, recent activity, system health

set -euo pipefail

# Configuration
META_PROJECT="${HOME}/devvyn-meta-project"
BRIDGE_ROOT="/Users/devvynmurphy/infrastructure/agent-bridge/bridge"
GITHUB_ROOT="${HOME}/Documents/GitHub"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Get terminal width for responsive layout
TERM_WIDTH=$(tput cols 2>/dev/null || echo 80)

print_separator() {
    local char="${1:-â”€}"
    printf "${BLUE}"
    printf "${char}%.0s" $(seq 1 $TERM_WIDTH)
    printf "${NC}\n"
}

print_header() {
    local title="$1"
    echo -e "${BOLD}${BLUE}${title}${NC}"
}

# Bridge Messages Summary
show_bridge_messages() {
    print_header "ğŸ“¬ Bridge Messages"

    # Check code inbox
    local code_inbox="${BRIDGE_ROOT}/inbox/code"
    if [[ -d "$code_inbox" ]]; then
        local msg_count=$(fd -t f ".*\.md" "$code_inbox" 2>/dev/null | wc -l | tr -d ' ')

        if [[ "$msg_count" -gt 0 ]]; then
            echo -e "  ${YELLOW}$msg_count unread message(s)${NC}"

            # Show latest message preview
            local latest=$(fd -t f ".*\.md" "$code_inbox" -x ls -t {} \; 2>/dev/null | head -1)
            if [[ -n "$latest" ]]; then
                local title=$(basename "$latest" | sed 's/\.md$//' | cut -c1-50)
                echo -e "  Latest: ${CYAN}${title}${NC}"
            fi
        else
            echo -e "  ${GREEN}âœ“ No pending messages${NC}"
        fi
    else
        echo -e "  ${YELLOW}Bridge inbox not found${NC}"
    fi
}

# Active Projects Summary
show_active_projects() {
    print_header "ğŸ“‚ Active Projects"

    # Get recent git activity
    local projects=()

    if [[ -d "$GITHUB_ROOT" ]]; then
        # Find repos with recent commits (last 7 days)
        while IFS= read -r repo; do
            if [[ -d "$repo/.git" ]]; then
                local last_commit=$(cd "$repo" && git log -1 --format="%cr" 2>/dev/null || echo "")
                if [[ -n "$last_commit" ]] && echo "$last_commit" | /usr/bin/grep -qE "(hour|day|minute|second)"; then
                    local repo_name=$(basename "$repo")
                    projects+=("$repo_name|$last_commit")
                fi
            fi
        done < <(fd -t d -d 1 ".*" "$GITHUB_ROOT" 2>/dev/null)
    fi

    if [[ ${#projects[@]} -gt 0 ]]; then
        for proj in "${projects[@]}"; do
            local name=$(echo "$proj" | cut -d'|' -f1)
            local age=$(echo "$proj" | cut -d'|' -f2)
            echo -e "  ${GREEN}â€¢${NC} ${name} ${CYAN}(${age})${NC}"
        done
    else
        echo -e "  ${YELLOW}No recent activity${NC}"
    fi
}

# System Health Check
show_system_health() {
    print_header "ğŸ¥ System Health"

    # Check bridge system
    if [[ -d "$BRIDGE_ROOT" ]]; then
        echo -e "  ${GREEN}âœ“${NC} Bridge system operational"
    else
        echo -e "  ${RED}âœ—${NC} Bridge system not found"
    fi

    # Check meta-project
    if [[ -d "$META_PROJECT" ]]; then
        echo -e "  ${GREEN}âœ“${NC} Meta-project accessible"
    else
        echo -e "  ${YELLOW}!${NC} Meta-project not found"
    fi

    # Check tools
    local tools_ok=true
    command -v uv >/dev/null 2>&1 || tools_ok=false
    command -v fd >/dev/null 2>&1 || tools_ok=false
    command -v rg >/dev/null 2>&1 || tools_ok=false

    if [[ "$tools_ok" == true ]]; then
        echo -e "  ${GREEN}âœ“${NC} Core tools available (uv, fd, rg)"
    else
        echo -e "  ${YELLOW}!${NC} Some tools missing"
    fi
}

# Recent Activity
show_recent_activity() {
    print_header "ğŸ“Š Recent Activity"

    # Show recent bridge events
    local events_log="${META_PROJECT}/logs/events.log"

    if [[ -f "$events_log" ]]; then
        echo -e "  Last 3 events:"
        tail -3 "$events_log" 2>/dev/null | while read -r line; do
            local timestamp=$(echo "$line" | cut -d' ' -f1,2)
            local event=$(echo "$line" | cut -d' ' -f3-)
            echo -e "    ${CYAN}${timestamp}${NC} ${event:0:50}"
        done
    else
        echo -e "  ${YELLOW}No event log found${NC}"
    fi
}

# Quick Actions
show_quick_actions() {
    print_header "âš¡ Quick Actions"

    echo -e "  ${GREEN}ask-claude${NC}       - Send quick query"
    echo -e "  ${GREEN}voice-bridge${NC}     - Send voice message"
    echo -e "  ${GREEN}voice-note${NC}       - Capture knowledge"
    echo -e "  ${GREEN}voice-dict-helper${NC} - Manage tech terms"
}

# Main Dashboard
main() {
    clear

    echo -e "${BOLD}${BLUE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘           Claude Code Workspace Dashboard                â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"

    show_bridge_messages
    echo ""

    show_active_projects
    echo ""

    show_system_health
    echo ""

    show_recent_activity
    echo ""

    show_quick_actions
    echo ""

    print_separator "â”€"
    echo -e "${CYAN}Last updated: $(date '+%Y-%m-%d %H:%M:%S')${NC}"
    echo ""
}

# Handle options
case "${1:-}" in
    --help|-h)
        echo "claude-status - Workspace dashboard"
        echo ""
        echo "Shows a one-screen overview of:"
        echo "  â€¢ Pending bridge messages"
        echo "  â€¢ Active projects"
        echo "  â€¢ System health"
        echo "  â€¢ Recent activity"
        echo "  â€¢ Quick action commands"
        exit 0
        ;;
    *)
        main
        ;;
esac
