#!/bin/bash
# Bridge Health Check - System verification and diagnostics
# Checks LaunchAgents, locks, permissions, and bridge integrity

set -euo pipefail

BRIDGE_ROOT="/Users/devvynmurphy/infrastructure/agent-bridge/bridge"
META_PROJECT="/Users/devvynmurphy/devvyn-meta-project"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Health check counters
CHECKS_RUN=0
CHECKS_PASSED=0
CHECKS_WARNING=0
CHECKS_FAILED=0

print_color() {
    local color=$1
    shift
    echo -e "${color}$*${NC}"
}

check_pass() {
    CHECKS_RUN=$((CHECKS_RUN + 1))
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
    print_color "$GREEN" "  âœ“ $1"
}

check_warning() {
    CHECKS_RUN=$((CHECKS_RUN + 1))
    CHECKS_WARNING=$((CHECKS_WARNING + 1))
    print_color "$YELLOW" "  âš  $1"
}

check_fail() {
    CHECKS_RUN=$((CHECKS_RUN + 1))
    CHECKS_FAILED=$((CHECKS_FAILED + 1))
    print_color "$RED" "  âœ— $1"
}

section_header() {
    echo ""
    print_color "$BOLD$BLUE" "â”â”â” $1 â”â”â”"
}

# Check bridge directory structure
check_bridge_structure() {
    section_header "BRIDGE DIRECTORY STRUCTURE"

    local required_dirs=(
        "$BRIDGE_ROOT/queue/pending"
        "$BRIDGE_ROOT/queue/processing"
        "$BRIDGE_ROOT/inbox/code"
        "$BRIDGE_ROOT/inbox/chat"
        "$BRIDGE_ROOT/outbox/code"
        "$BRIDGE_ROOT/outbox/chat"
        "$BRIDGE_ROOT/registry"
    )

    for dir in "${required_dirs[@]}"; do
        if [ -d "$dir" ]; then
            check_pass "Directory exists: $(basename "$(dirname "$dir")")/$(basename "$dir")"
        else
            check_fail "Missing directory: $dir"
        fi
    done

    # Check key files
    if [ -f "$BRIDGE_ROOT/registry/agents.json" ]; then
        check_pass "Agent registry exists"
    else
        check_warning "Agent registry missing (will be created on first registration)"
    fi
}

# Check for stale locks
check_locks() {
    section_header "LOCK FILE CHECK"

    local lock_count=$(find "$BRIDGE_ROOT/queue/processing" -name "*.lock" 2>/dev/null | wc -l | tr -d ' ')

    if [ "$lock_count" -eq 0 ]; then
        check_pass "No lock files found"
    else
        check_warning "Found $lock_count lock file(s)"
        echo ""
        print_color "$YELLOW" "    Lock files found:"
        find "$BRIDGE_ROOT/queue/processing" -name "*.lock" -exec ls -lh {} \; | while read -r line; do
            echo "      $line"
        done
        echo ""
        print_color "$YELLOW" "    If these are stale (older than 5 minutes), remove with:"
        echo "      rm -f $BRIDGE_ROOT/queue/processing/*.lock"
    fi
}

# Check LaunchAgents
check_launchagents() {
    section_header "LAUNCHAGENT STATUS"

    # Queue processor
    if launchctl list | grep -q "devvyn.*queue.*processor"; then
        check_pass "Queue processor is running"
    else
        check_fail "Queue processor not running"
        echo ""
        print_color "$YELLOW" "    Load with:"
        echo "      launchctl load ~/Library/LaunchAgents/com.devvyn.bridge-queue-processor.plist"
    fi

    # Unanswered monitor
    if launchctl list | grep -q "devvyn.*unanswered"; then
        check_pass "Unanswered monitor is running"
    else
        check_warning "Unanswered monitor not running (non-critical)"
    fi

    # INVESTIGATOR
    if launchctl list | grep -q "investigator"; then
        check_pass "INVESTIGATOR agent is registered"
    else
        check_warning "INVESTIGATOR agent not registered (non-critical)"
    fi
}

# Check queue health
check_queue_health() {
    section_header "QUEUE HEALTH"

    local pending_count=$(find "$BRIDGE_ROOT/queue/pending" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    local processing_count=$(find "$BRIDGE_ROOT/queue/processing" -type f -name "*.md" 2>/dev/null | wc -l | tr -d ' ')

    echo "  Pending messages: $pending_count"
    echo "  Processing messages: $processing_count"

    if [ "$pending_count" -eq 0 ]; then
        check_pass "No backlog in pending queue"
    elif [ "$pending_count" -lt 5 ]; then
        check_warning "$pending_count messages pending (normal)"
    else
        check_fail "Large backlog: $pending_count messages pending"
        echo ""
        print_color "$YELLOW" "    Process queue manually with:"
        echo "      $META_PROJECT/scripts/bridge-process-queue.sh"
    fi

    if [ "$processing_count" -gt 0 ]; then
        check_warning "$processing_count messages stuck in processing"
        echo ""
        print_color "$YELLOW" "    Check for stale locks and clear if needed"
    fi
}

# Check agent registrations
check_agent_registrations() {
    section_header "AGENT REGISTRATIONS"

    if [ ! -f "$BRIDGE_ROOT/registry/agents.json" ]; then
        check_warning "No agent registry found"
        return
    fi

    local agents=$(jq -r '.active_agents | keys[]' "$BRIDGE_ROOT/registry/agents.json" 2>/dev/null)

    if [ -z "$agents" ]; then
        check_warning "No agents registered"
        echo ""
        print_color "$YELLOW" "    Register with:"
        echo "      $META_PROJECT/scripts/bridge-register.sh register <agent_name>"
    else
        check_pass "Agents registered: $(echo "$agents" | tr '\n' ' ')"
    fi
}

# Check permissions
check_permissions() {
    section_header "PERMISSIONS"

    # Check if directories are writable
    if [ -w "$BRIDGE_ROOT/queue/pending" ]; then
        check_pass "Queue pending directory is writable"
    else
        check_fail "Queue pending directory not writable"
    fi

    if [ -w "$BRIDGE_ROOT/inbox/code" ]; then
        check_pass "Code inbox is writable"
    else
        check_fail "Code inbox not writable"
    fi

    # Check script executability
    local scripts=(
        "$META_PROJECT/scripts/bridge-send.sh"
        "$META_PROJECT/scripts/bridge-receive.sh"
        "$META_PROJECT/scripts/bridge-process-queue.sh"
    )

    for script in "${scripts[@]}"; do
        if [ -x "$script" ]; then
            check_pass "$(basename "$script") is executable"
        else
            check_fail "$(basename "$script") not executable or not found"
        fi
    done
}

# Check recent errors
check_recent_errors() {
    section_header "RECENT ERRORS"

    local log_dir="$META_PROJECT/logs"

    if [ ! -d "$log_dir" ]; then
        check_warning "No logs directory found"
        return
    fi

    # Check for recent errors in wrapper logs
    local error_count=0

    for log_file in "$log_dir"/*wrapper-errors.log; do
        if [ -f "$log_file" ]; then
            local recent_errors=$(tail -n 50 "$log_file" 2>/dev/null | grep -i "error\|fail" | wc -l | tr -d ' ')
            error_count=$((error_count + recent_errors))
        fi
    done

    if [ "$error_count" -eq 0 ]; then
        check_pass "No recent errors in logs"
    elif [ "$error_count" -lt 5 ]; then
        check_warning "$error_count recent errors found (review logs)"
    else
        check_fail "$error_count recent errors found"
        echo ""
        print_color "$YELLOW" "    Review logs at:"
        echo "      $log_dir/"
    fi
}

# Check workspace integration
check_workspace() {
    section_header "WORKSPACE INTEGRATION"

    local workspace_root="/Users/devvynmurphy/infrastructure/agent-bridge/workspace"

    if [ -d "$workspace_root" ]; then
        check_pass "Workspace directory exists"
    else
        check_fail "Workspace directory not found"
        return
    fi

    # Check key scripts
    local workspace_scripts=(
        "bridge-send-universal.sh"
        "bridge-receive-universal.sh"
        "compose-message.sh"
        "bridge-status.sh"
    )

    for script in "${workspace_scripts[@]}"; do
        if [ -x "$workspace_root/scripts/$script" ]; then
            check_pass "Workspace script: $script"
        else
            check_warning "Workspace script missing: $script"
        fi
    done
}

# Print summary
print_summary() {
    echo ""
    echo ""
    print_color "$BOLD$BLUE" "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    print_color "$BOLD$BLUE" "â•‘                HEALTH CHECK SUMMARY                        â•‘"
    print_color "$BOLD$BLUE" "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "Total Checks:  $CHECKS_RUN"
    print_color "$GREEN" "Passed:        $CHECKS_PASSED"
    print_color "$YELLOW" "Warnings:      $CHECKS_WARNING"
    print_color "$RED" "Failed:        $CHECKS_FAILED"
    echo ""

    if [ $CHECKS_FAILED -eq 0 ] && [ $CHECKS_WARNING -eq 0 ]; then
        print_color "$GREEN" "ğŸ‰ SYSTEM HEALTHY - All checks passed!"
        return 0
    elif [ $CHECKS_FAILED -eq 0 ]; then
        print_color "$YELLOW" "âš  SYSTEM OPERATIONAL - Minor warnings present"
        return 0
    else
        print_color "$RED" "âŒ SYSTEM ISSUES - Critical failures detected"
        print_color "$YELLOW" "Review failures above and take corrective action"
        return 1
    fi
}

# Main
main() {
    print_color "$BOLD$BLUE" "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    print_color "$BOLD$BLUE" "â•‘          Bridge Health Check & Diagnostics                 â•‘"
    print_color "$BOLD$BLUE" "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    print_color "$CYAN" "Checking bridge system integrity..."

    check_bridge_structure
    check_locks
    check_launchagents
    check_queue_health
    check_agent_registrations
    check_permissions
    check_recent_errors
    check_workspace

    print_summary
}

main "$@"
