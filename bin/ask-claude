#!/bin/bash
# ask-claude - Quick voice/text queries to Claude Code
# Usage: ask-claude [message]
#        ask-claude  (interactive mode with voice support)

set -euo pipefail

# Configuration
BRIDGE_SEND="${HOME}/devvyn-meta-project/scripts/bridge-send.sh"
TEMP_DIR="/tmp/ask-claude"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

mkdir -p "$TEMP_DIR"

usage() {
    cat <<EOF
${BLUE}ask-claude${NC} - Quick queries to Claude Code

Usage:
  ask-claude "your question or command here"
  ask-claude                    # Interactive mode

Examples:
  ask-claude "what's the status of the AAFC project?"
  ask-claude "explain the bridge system"
  ask-claude "run the tests and fix any failures"
  ask-claude                    # Opens prompt for voice dictation

${GREEN}Tip: In interactive mode, use Fn-Fn for voice dictation${NC}

EOF
    exit 0
}

# Check for help flag
if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
    usage
fi

# Determine message content
if [[ $# -eq 0 ]]; then
    # Interactive mode
    echo -e "${BLUE}ask-claude${NC} - Interactive Mode"
    echo -e "${GREEN}Tip: Use voice dictation (Fn-Fn) to speak your query${NC}"
    echo ""
    echo -ne "${BLUE}Your question/command:${NC} "
    read -r MESSAGE
else
    # Direct mode - message provided as arguments
    MESSAGE="$*"
fi

# Validate we have a message
if [[ -z "$MESSAGE" ]]; then
    echo -e "${YELLOW}No message provided. Exiting.${NC}"
    exit 1
fi

# Create content file
CONTENT_FILE="$TEMP_DIR/query-$(date +%s).md"
cat > "$CONTENT_FILE" <<EOF
# Quick Query

$MESSAGE

---
*Sent via ask-claude at $(date)*
EOF

# Auto-classify priority based on keywords
PRIORITY="NORMAL"
if echo "$MESSAGE" | /usr/bin/grep -qiE "urgent|critical|emergency|broken|failing|error"; then
    PRIORITY="HIGH"
elif echo "$MESSAGE" | /usr/bin/grep -qiE "when you can|fyi|info|note|noticed"; then
    PRIORITY="INFO"
fi

# Extract a topic from the message (first 50 chars)
TOPIC=$(echo "$MESSAGE" | cut -c1-50)
if [[ ${#MESSAGE} -gt 50 ]]; then
    TOPIC="${TOPIC}..."
fi

# Send via bridge
echo -e "${GREEN}Sending to Claude Code...${NC}"

if "$BRIDGE_SEND" "human" "code" "$PRIORITY" "$TOPIC" "$CONTENT_FILE"; then
    echo -e "${GREEN}âœ“ Query sent!${NC}"

    # Audio feedback
    command -v say >/dev/null 2>&1 && say "Query sent to Claude" &

    rm -f "$CONTENT_FILE"
else
    echo -e "${YELLOW}Failed to send. Content saved to: ${CONTENT_FILE}${NC}"
    exit 1
fi
