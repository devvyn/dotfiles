#!/bin/bash
# voice-dict-helper - Manage technical term dictionary for voice recognition
# Helps with macOS text substitutions and custom vocabulary

set -euo pipefail

# Configuration
DICT_FILE="${HOME}/.config/voice-tech-terms.json"
BACKUP_DIR="${HOME}/.config/voice-dict-backups"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

mkdir -p "$BACKUP_DIR"

usage() {
    cat <<EOF
${BLUE}voice-dict-helper${NC} - Technical Term Dictionary Manager

Usage:
  voice-dict-helper list [category]    List all terms or by category
  voice-dict-helper tips               Show voice dictation tips
  voice-dict-helper add <phrase> <shortcut>  Add a new substitution
  voice-dict-helper export             Export for manual import
  voice-dict-helper vocab              Show custom vocabulary list
  voice-dict-helper setup              Interactive setup guide

Categories:
  package_managers, file_tools, git_commands, common_flags,
  file_patterns, project_specific, python_specific, shell_syntax,
  programming_symbols

Examples:
  voice-dict-helper list package_managers
  voice-dict-helper tips
  voice-dict-helper add "pytest" "pie test"
  voice-dict-helper setup

EOF
    exit 0
}

list_terms() {
    local category="${1:-all}"

    if [[ ! -f "$DICT_FILE" ]]; then
        echo -e "${RED}Dictionary file not found: $DICT_FILE${NC}"
        exit 1
    fi

    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo -e "${BLUE}   Technical Term Dictionary${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo ""

    if [[ "$category" == "all" ]]; then
        # List all categories
        local categories=$(jq -r '.categories | keys[]' "$DICT_FILE")

        for cat in $categories; do
            echo -e "${GREEN}Category: ${cat}${NC}"
            jq -r ".categories.${cat}[] | \"  \(.shortcut) → \(.phrase)\"" "$DICT_FILE" 2>/dev/null || true
            echo ""
        done
    else
        # List specific category
        if jq -e ".categories.${category}" "$DICT_FILE" >/dev/null 2>&1; then
            echo -e "${GREEN}Category: ${category}${NC}"
            jq -r ".categories.${category}[] | \"  Say: '\(.shortcut)' → Gets: '\(.phrase)'\"" "$DICT_FILE"
            echo ""

            # Show alternatives if any
            local has_alts=$(jq -r ".categories.${category}[] | select(.alternatives) | .phrase" "$DICT_FILE" 2>/dev/null || true)
            if [[ -n "$has_alts" ]]; then
                echo -e "${YELLOW}Alternative phrases:${NC}"
                jq -r ".categories.${category}[] | select(.alternatives) | \"  \(.phrase): \(.alternatives | join(\", \"))\"" "$DICT_FILE"
            fi
        else
            echo -e "${RED}Category '${category}' not found${NC}"
            echo -e "${YELLOW}Available categories:${NC}"
            jq -r '.categories | keys[]' "$DICT_FILE"
            exit 1
        fi
    fi
}

show_tips() {
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo -e "${BLUE}   macOS Dictation Tips${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${GREEN}Built-in Voice Commands:${NC}"

    jq -r '.macos_dictation_tips[]' "$DICT_FILE" | while read -r tip; do
        echo "  • $tip"
    done

    echo ""
    echo -e "${YELLOW}Pro Tips:${NC}"
    echo "  • Activate dictation: Press Fn key twice (or your configured shortcut)"
    echo "  • Pause briefly between commands and content"
    echo "  • Speak punctuation explicitly for code"
    echo "  • Use 'no space' to join words without spaces"
    echo ""
}

show_vocab() {
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo -e "${BLUE}   Custom Vocabulary Terms${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}Add these to: System Settings > Keyboard > Dictation${NC}"
    echo ""

    jq -r '.custom_vocabulary.terms[]' "$DICT_FILE" | while read -r term; do
        echo "  • $term"
    done

    echo ""
}

add_term() {
    local phrase="$1"
    local shortcut="$2"
    local category="${3:-custom}"

    echo -e "${GREEN}Adding term to dictionary...${NC}"
    echo "  Phrase: $phrase"
    echo "  Shortcut: $shortcut"
    echo "  Category: $category"
    echo ""

    # Backup current dictionary
    cp "$DICT_FILE" "$BACKUP_DIR/voice-tech-terms-$(date +%Y%m%d-%H%M%S).json"

    # Add to custom category or create it
    if ! jq -e ".categories.${category}" "$DICT_FILE" >/dev/null 2>&1; then
        # Create category if it doesn't exist
        jq ".categories.${category} = []" "$DICT_FILE" > "${DICT_FILE}.tmp"
        mv "${DICT_FILE}.tmp" "$DICT_FILE"
    fi

    # Add the term
    jq ".categories.${category} += [{\"phrase\": \"${phrase}\", \"shortcut\": \"${shortcut}\"}]" "$DICT_FILE" > "${DICT_FILE}.tmp"
    mv "${DICT_FILE}.tmp" "$DICT_FILE"

    echo -e "${GREEN}✓ Term added successfully!${NC}"
}

export_for_import() {
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo -e "${BLUE}   Export for Manual Import${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}To add these to macOS text substitutions:${NC}"
    echo "  1. Go to: System Settings > Keyboard > Text"
    echo "  2. Click '+' to add each replacement"
    echo "  3. Copy the 'Replace' and 'With' values from below"
    echo ""
    echo -e "${GREEN}Substitutions:${NC}"
    echo ""

    # Create a formatted export
    local export_file="${HOME}/Desktop/voice-substitutions-$(date +%Y%m%d).txt"

    {
        echo "macOS Text Substitutions - Voice Recognition Helper"
        echo "Generated: $(date)"
        echo ""
        echo "To import: System Settings > Keyboard > Text > +"
        echo ""
        echo "Format: Replace | With"
        echo "─────────────────────────────────────────────"

        jq -r '.categories[] | .[] | "\(.shortcut) | \(.phrase)"' "$DICT_FILE"
    } > "$export_file"

    cat "$export_file"

    echo ""
    echo -e "${GREEN}✓ Exported to: ${export_file}${NC}"
}

interactive_setup() {
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo -e "${BLUE}   Voice Recognition Setup Guide${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}⚠️  IMPORTANT: Voice Control vs Voice Dictation${NC}"
    echo ""
    echo "macOS has TWO separate voice systems that are MUTUALLY EXCLUSIVE:"
    echo ""
    echo -e "${CYAN}Voice Control${NC} (Accessibility):"
    echo "  • Full system control (UI navigation, clicking, etc.)"
    echo "  • Customizable vocabulary ✓"
    echo "  • Required for accessibility needs"
    echo ""
    echo -e "${CYAN}Voice Dictation${NC} (Keyboard feature):"
    echo "  • Text input only"
    echo "  • NO custom vocabulary ✗"
    echo "  • Better punctuation/spacing"
    echo ""
    echo -e "${RED}You can only enable ONE at a time!${NC}"
    echo ""
    echo -ne "Which are you using? (control/dictation): "
    read -r voice_mode
    echo ""

    if [[ "$voice_mode" =~ ^[Cc] ]]; then
        echo -e "${GREEN}Voice Control Setup${NC}"
        echo ""
        echo -e "${CYAN}Step 1: Enable Voice Control${NC}"
        echo "  1. System Settings > Accessibility > Voice Control"
        echo "  2. Turn on Voice Control"
        echo "  3. Configure microphone"
        echo ""
        read -p "Press Enter when Voice Control is enabled..."

        echo ""
        echo -e "${CYAN}Step 2: Add Custom Vocabulary to Voice Control${NC}"
        show_vocab
        echo ""
        echo "  To add these terms:"
        echo "  1. System Settings > Accessibility > Voice Control"
        echo "  2. Click 'Vocabulary...'"
        echo "  3. Add each term from the list above"
        echo ""
        read -p "Press Enter when vocabulary is added..."

        echo ""
        echo -e "${CYAN}Step 3: Create Custom Commands (Optional)${NC}"
        echo "  Voice Control lets you create custom commands like:"
        echo "  • 'package manager uv' → types 'uv'"
        echo "  • 'help flag' → types '--help'"
        echo ""
        echo "  System Settings > Accessibility > Voice Control > Commands..."
        echo ""
        read -p "Press Enter to continue..."

    else
        echo -e "${YELLOW}Voice Dictation Setup${NC}"
        echo ""
        echo -e "${RED}⚠️  WARNING:${NC}"
        echo "  Voice Dictation does NOT support custom vocabulary!"
        echo "  You'll need to spell out technical terms manually."
        echo ""
        echo -e "${CYAN}Step 1: Enable Dictation${NC}"
        echo "  1. System Settings > Keyboard > Dictation"
        echo "  2. Turn on Dictation"
        echo "  3. Set shortcut (default: Press Fn twice)"
        echo ""
        read -p "Press Enter when dictation is enabled..."

        echo ""
        echo -e "${YELLOW}Note:${NC} With Dictation, you'll say things like:"
        echo "  'U V space install space dash dash help'"
        echo "  Instead of: 'package manager uv install help flag'"
    fi

    echo ""
    echo -e "${GREEN}Step 4: Quick Reference${NC}"
    show_tips

    echo ""
    echo -e "${GREEN}✓ Setup complete!${NC}"
    echo ""
    echo "Next steps:"
    echo "  • Try: voice-dict-helper list"
    echo "  • Try: ask-claude"
    echo "  • Try: voice-bridge"
}

# Main command dispatcher
case "${1:-}" in
    list)
        list_terms "${2:-all}"
        ;;
    tips)
        show_tips
        ;;
    vocab)
        show_vocab
        ;;
    add)
        if [[ $# -lt 3 ]]; then
            echo -e "${RED}Error: 'add' requires phrase and shortcut${NC}"
            echo "Usage: voice-dict-helper add <phrase> <shortcut> [category]"
            exit 1
        fi
        add_term "$2" "$3" "${4:-custom}"
        ;;
    export)
        export_for_import
        ;;
    setup)
        interactive_setup
        ;;
    -h|--help|help)
        usage
        ;;
    *)
        echo -e "${RED}Unknown command: ${1:-}${NC}"
        echo ""
        usage
        ;;
esac
