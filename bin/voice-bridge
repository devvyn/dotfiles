#!/bin/bash
# Voice-to-Bridge Message Creator
# Captures voice input (via macOS dictation) and creates bridge messages
# Usage: voice-bridge [recipient]

set -euo pipefail

# Configuration
BRIDGE_SEND="${HOME}/devvyn-meta-project/scripts/bridge-send.sh"
META_PROJECT="${HOME}/devvyn-meta-project"
TEMP_DIR="/tmp/voice-bridge"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Ensure temp directory exists
mkdir -p "$TEMP_DIR"

usage() {
    cat <<EOF
${BLUE}Voice-to-Bridge Message Creator${NC}

Usage: voice-bridge [options] [recipient]

Arguments:
  recipient    Target agent (code, chat, human, gpt) [default: code]

Options:
  -h, --help   Show this help message

How to use:
  1. Run: voice-bridge
  2. You'll be prompted for topic, priority, and message
  3. Use macOS dictation (Fn-Fn or your configured key) to voice-fill each field
  4. Message will be automatically sent via bridge system

Example:
  voice-bridge code
  > Topic: Framework enhancement ideas
  > Priority: HIGH
  > Message: [Use voice dictation to describe your ideas]

EOF
    exit 0
}

# Parse arguments
RECIPIENT="${1:-code}"

if [[ "$RECIPIENT" == "-h" ]] || [[ "$RECIPIENT" == "--help" ]]; then
    usage
fi

# Validate recipient
case "$RECIPIENT" in
    code|chat|human|gpt|codex)
        ;;
    *)
        echo -e "${YELLOW}Warning: Unknown recipient '$RECIPIENT', defaulting to 'code'${NC}"
        RECIPIENT="code"
        ;;
esac

echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo -e "${BLUE}   Voice-to-Bridge Message Creator${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo ""
echo -e "${GREEN}Tip: Use Fn-Fn (or your configured key) to activate voice dictation${NC}"
echo -e "Recipient: ${YELLOW}${RECIPIENT}${NC}"
echo ""

# Collect topic
echo -ne "${BLUE}Topic/Title:${NC} "
read -r TOPIC

if [[ -z "$TOPIC" ]]; then
    echo -e "${YELLOW}No topic provided. Exiting.${NC}"
    exit 1
fi

# Collect priority
echo ""
echo -e "${BLUE}Priority (CRITICAL, HIGH, NORMAL, INFO):${NC} "
echo -ne "> "
read -r PRIORITY

# Default to NORMAL if empty
PRIORITY="${PRIORITY:-NORMAL}"

# Validate and normalize priority
PRIORITY=$(echo "$PRIORITY" | tr '[:lower:]' '[:upper:]')
case "$PRIORITY" in
    C|CRIT|CRITICAL)
        PRIORITY="CRITICAL"
        ;;
    H|HIGH)
        PRIORITY="HIGH"
        ;;
    N|NORM|NORMAL)
        PRIORITY="NORMAL"
        ;;
    I|INFO)
        PRIORITY="INFO"
        ;;
    *)
        echo -e "${YELLOW}Unknown priority '$PRIORITY', using NORMAL${NC}"
        PRIORITY="NORMAL"
        ;;
esac

# Collect message content
echo ""
echo -e "${BLUE}Message Content:${NC}"
echo -e "${GREEN}(Type or use voice dictation. Press Ctrl-D when done, or type END on a new line)${NC}"
echo ""

CONTENT_FILE="$TEMP_DIR/message-$(date +%s).md"

# Use a here-doc style capture that works with voice dictation
{
    while IFS= read -r line; do
        if [[ "$line" == "END" ]]; then
            break
        fi
        echo "$line"
    done
} > "$CONTENT_FILE"

# Check if content was provided
if [[ ! -s "$CONTENT_FILE" ]]; then
    echo -e "${YELLOW}No content provided. Exiting.${NC}"
    rm -f "$CONTENT_FILE"
    exit 1
fi

# Show summary
echo ""
echo -e "${BLUE}─────────────────────────────────────────────${NC}"
echo -e "${GREEN}Message Summary:${NC}"
echo -e "  To: ${YELLOW}${RECIPIENT}${NC}"
echo -e "  Priority: ${YELLOW}${PRIORITY}${NC}"
echo -e "  Topic: ${YELLOW}${TOPIC}${NC}"
echo -e "${BLUE}─────────────────────────────────────────────${NC}"
echo ""
echo -e "${GREEN}Content preview:${NC}"
head -5 "$CONTENT_FILE"
echo ""

# Confirm send
echo -ne "${BLUE}Send this message? (y/N):${NC} "
read -r CONFIRM

if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}Message not sent. Content saved to: ${CONTENT_FILE}${NC}"
    exit 0
fi

# Send via bridge
echo ""
echo -e "${GREEN}Sending message via bridge system...${NC}"

# Determine sender (assume human for voice input)
SENDER="human"

# Send the message
if "$BRIDGE_SEND" "$SENDER" "$RECIPIENT" "$PRIORITY" "$TOPIC" "$CONTENT_FILE"; then
    echo -e "${GREEN}✓ Message sent successfully!${NC}"

    # Provide audio feedback if available
    command -v say >/dev/null 2>&1 && say "Message sent" &

    # Clean up temp file
    rm -f "$CONTENT_FILE"
else
    echo -e "${YELLOW}Failed to send message. Content saved to: ${CONTENT_FILE}${NC}"
    exit 1
fi

echo ""
echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
