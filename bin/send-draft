#!/bin/bash
# Send Draft Message - Extract metadata and send via bridge
# Parses draft file for From/To/Priority and sends via bridge-send-universal.sh

set -euo pipefail

WORKSPACE_ROOT="/Users/devvynmurphy/infrastructure/agent-bridge/workspace"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_color() {
    local color=$1
    shift
    echo -e "${color}$*${NC}"
}

usage() {
    echo "Usage: $0 <draft_file>"
    echo ""
    echo "Sends a draft message by extracting metadata and using bridge-send-universal.sh"
    echo ""
    echo "The draft file should contain:"
    echo "  - Title with [PRIORITY: ...] prefix"
    echo "  - **From**: sender"
    echo "  - **To**: recipient"
    exit 1
}

if [ $# -ne 1 ]; then
    usage
fi

DRAFT_FILE="$1"

if [ ! -f "$DRAFT_FILE" ]; then
    print_color "$RED" "Error: Draft file not found: $DRAFT_FILE"
    exit 1
fi

# Extract metadata from draft
print_color "$YELLOW" "Parsing draft: $DRAFT_FILE"

# Extract priority and title from first line (e.g., "# [PRIORITY: HIGH] Title Here")
FIRST_LINE=$(head -n 1 "$DRAFT_FILE" | sed 's/^# //')
if [[ "$FIRST_LINE" =~ ^\[PRIORITY:\ ([A-Z]+)\]\ (.+)$ ]]; then
    PRIORITY="${BASH_REMATCH[1]}"
    TITLE="${BASH_REMATCH[2]}"
else
    print_color "$RED" "Error: Could not parse priority and title from first line"
    print_color "$YELLOW" "Expected format: # [PRIORITY: HIGH] Title Here"
    print_color "$YELLOW" "Got: $FIRST_LINE"
    exit 1
fi

# Extract From field
FROM_LINE=$(grep -m 1 '^\*\*From\*\*:' "$DRAFT_FILE" || echo "")
if [ -n "$FROM_LINE" ]; then
    SENDER=$(echo "$FROM_LINE" | sed 's/\*\*From\*\*:[[:space:]]*//')
else
    print_color "$RED" "Error: Could not find **From**: field in draft"
    exit 1
fi

# Extract To field
TO_LINE=$(grep -m 1 '^\*\*To\*\*:' "$DRAFT_FILE" || echo "")
if [ -n "$TO_LINE" ]; then
    RECIPIENT=$(echo "$TO_LINE" | sed 's/\*\*To\*\*:[[:space:]]*//')
else
    print_color "$RED" "Error: Could not find **To**: field in draft"
    exit 1
fi

# Display parsed info
echo ""
print_color "$GREEN" "Parsed message details:"
echo "  From:     $SENDER"
echo "  To:       $RECIPIENT"
echo "  Priority: $PRIORITY"
echo "  Title:    $TITLE"
echo ""

# Confirm send
read -p "$(print_color "$YELLOW" "Send this message? (Y/n): ")" CONFIRM
CONFIRM=${CONFIRM:-Y}

if [[ ! "$CONFIRM" =~ ^[Yy] ]]; then
    print_color "$YELLOW" "Send cancelled"
    exit 0
fi

# Send via universal bridge script
SEND_SCRIPT="$WORKSPACE_ROOT/scripts/bridge-send-universal.sh"

if [ ! -x "$SEND_SCRIPT" ]; then
    print_color "$RED" "Error: bridge-send-universal.sh not found or not executable"
    exit 1
fi

print_color "$YELLOW" "Sending message..."
"$SEND_SCRIPT" "$SENDER" "$RECIPIENT" "$PRIORITY" "$TITLE" "$DRAFT_FILE"

if [ $? -eq 0 ]; then
    print_color "$GREEN" "Message sent successfully!"

    # Archive the draft
    DRAFT_DIR=$(dirname "$DRAFT_FILE")
    ARCHIVE_DIR="$DRAFT_DIR/sent"
    mkdir -p "$ARCHIVE_DIR"

    DRAFT_BASENAME=$(basename "$DRAFT_FILE")
    mv "$DRAFT_FILE" "$ARCHIVE_DIR/$DRAFT_BASENAME"

    print_color "$YELLOW" "Draft archived to: $ARCHIVE_DIR/$DRAFT_BASENAME"
else
    print_color "$RED" "Error: Message send failed"
    exit 1
fi

echo ""
print_color "$GREEN" "Done!"
