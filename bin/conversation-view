#!/bin/bash
# Conversation View - Visualize message threads with In-Reply-To chains
# Shows conversation flows across the bridge

set -euo pipefail

BRIDGE_ROOT="/Users/devvynmurphy/infrastructure/agent-bridge/bridge"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

print_color() {
    local color=$1
    shift
    echo -e "${color}$*${NC}"
}

# Extract message metadata
get_message_id() {
    local file=$1
    grep -m 1 '^\*\*Message-ID\*\*:' "$file" 2>/dev/null | sed 's/\*\*Message-ID\*\*:[[:space:]]*//' || echo ""
}

get_in_reply_to() {
    local file=$1
    grep -m 1 '^\*\*In-Reply-To\*\*:' "$file" 2>/dev/null | sed 's/\*\*In-Reply-To\*\*:[[:space:]]*//' || echo ""
}

get_from() {
    local file=$1
    grep -m 1 '^\*\*From\*\*:' "$file" 2>/dev/null | sed 's/\*\*From\*\*:[[:space:]]*//' || echo "unknown"
}

get_to() {
    local file=$1
    grep -m 1 '^\*\*To\*\*:' "$file" 2>/dev/null | sed 's/\*\*To\*\*:[[:space:]]*//' || echo "unknown"
}

get_timestamp() {
    local file=$1
    grep -m 1 '^\*\*Timestamp\*\*:' "$file" 2>/dev/null | sed 's/\*\*Timestamp\*\*:[[:space:]]*//' || echo ""
}

get_title() {
    local file=$1
    head -n 1 "$file" | sed 's/^# \[PRIORITY: [A-Z]*\] //' | sed 's/^# //'
}

get_priority() {
    local file=$1
    head -n 1 "$file" | grep -o 'PRIORITY: [A-Z]*' | sed 's/PRIORITY: //' || echo "NORMAL"
}

# Find message file by ID
find_message_by_id() {
    local msg_id=$1

    # Search in inbox
    find "$BRIDGE_ROOT/inbox" -type f -name "*.md" -exec grep -l "Message-ID.*$msg_id" {} \; 2>/dev/null | head -n 1

    # If not found, search in outbox
    if [ -z "${REPLY:-}" ]; then
        REPLY=$(find "$BRIDGE_ROOT/outbox" -type f -name "*.md" -exec grep -l "Message-ID.*$msg_id" {} \; 2>/dev/null | head -n 1)
    fi

    # If not found, search in archive
    if [ -z "${REPLY:-}" ]; then
        REPLY=$(find "$BRIDGE_ROOT/archive" -type f -name "*.md" -exec grep -l "Message-ID.*$msg_id" {} \; 2>/dev/null | head -n 1)
    fi

    echo "${REPLY:-}"
}

# Build conversation thread
build_thread() {
    local start_file=$1
    local depth=${2:-0}
    local indent=""

    for ((i=0; i<depth; i++)); do
        indent="  $indent"
    done

    # Get message details
    local msg_id=$(get_message_id "$start_file")
    local from=$(get_from "$start_file")
    local to=$(get_to "$start_file")
    local title=$(get_title "$start_file")
    local timestamp=$(get_timestamp "$start_file")
    local priority=$(get_priority "$start_file")

    # Truncate title if too long
    if [ ${#title} -gt 50 ]; then
        title="${title:0:47}..."
    fi

    # Print message node
    if [ $depth -eq 0 ]; then
        print_color "$BOLD$BLUE" "${indent}┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    else
        print_color "$CYAN" "${indent}┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    fi

    printf "${indent}"
    print_color "$YELLOW" "[$priority]"
    print_color "$GREEN" " $from"
    echo -n " → "
    print_color "$MAGENTA" "$to"
    echo ""

    printf "${indent}"
    print_color "$BOLD" "$title"
    echo ""

    printf "${indent}"
    print_color "$CYAN" "ID: ${msg_id:0:30}..."
    echo ""

    printf "${indent}"
    echo "Time: $timestamp"
    echo ""

    # Find replies to this message
    local replies=$(find "$BRIDGE_ROOT/inbox" "$BRIDGE_ROOT/outbox" "$BRIDGE_ROOT/archive" -type f -name "*.md" -exec grep -l "In-Reply-To.*$msg_id" {} \; 2>/dev/null)

    if [ -n "$replies" ]; then
        echo "$replies" | while read -r reply_file; do
            if [ -f "$reply_file" ]; then
                build_thread "$reply_file" $((depth + 1))
            fi
        done
    fi
}

# List all conversation threads
list_all_threads() {
    print_color "$BOLD$BLUE" "╔════════════════════════════════════════════════════════════╗"
    print_color "$BOLD$BLUE" "║           All Conversation Threads                         ║"
    print_color "$BOLD$BLUE" "╚════════════════════════════════════════════════════════════╝"
    echo ""

    # Find all messages that are NOT replies (i.e., root messages)
    local all_messages=$(find "$BRIDGE_ROOT/inbox" "$BRIDGE_ROOT/outbox" "$BRIDGE_ROOT/archive" -type f -name "*.md" 2>/dev/null)

    local thread_count=0

    echo "$all_messages" | while read -r file; do
        if [ -f "$file" ]; then
            local in_reply_to=$(get_in_reply_to "$file")

            # If no In-Reply-To, it's a root message
            if [ -z "$in_reply_to" ]; then
                thread_count=$((thread_count + 1))
                echo ""
                build_thread "$file" 0
            fi
        fi
    done

    echo ""
}

# Show specific conversation thread
show_thread() {
    local search_term=$1

    print_color "$BOLD$BLUE" "╔════════════════════════════════════════════════════════════╗"
    print_color "$BOLD$BLUE" "║           Conversation Thread Search                       ║"
    print_color "$BOLD$BLUE" "╚════════════════════════════════════════════════════════════╝"
    echo ""

    # Find message by ID or title
    local found_file=""

    # Try searching by message ID first
    found_file=$(find_message_by_id "$search_term")

    # If not found, try searching by title
    if [ -z "$found_file" ]; then
        found_file=$(find "$BRIDGE_ROOT/inbox" "$BRIDGE_ROOT/outbox" "$BRIDGE_ROOT/archive" -type f -name "*.md" -exec grep -l "$search_term" {} \; 2>/dev/null | head -n 1)
    fi

    if [ -n "$found_file" ] && [ -f "$found_file" ]; then
        print_color "$GREEN" "Found message: $(basename "$found_file")"
        echo ""

        # Find the root of this thread
        local current_file="$found_file"
        local parent_id=$(get_in_reply_to "$current_file")

        while [ -n "$parent_id" ]; do
            local parent_file=$(find_message_by_id "$parent_id")
            if [ -n "$parent_file" ] && [ -f "$parent_file" ]; then
                current_file="$parent_file"
                parent_id=$(get_in_reply_to "$current_file")
            else
                break
            fi
        done

        # Now display from root
        build_thread "$current_file" 0
        echo ""
    else
        print_color "$RED" "No message found matching: $search_term"
        echo ""
        print_color "$YELLOW" "Try:"
        echo "  - Message ID"
        echo "  - Part of message title"
        echo "  - Use --all to see all threads"
    fi
}

# Usage
usage() {
    echo "Usage: $0 [--all | <search_term>]"
    echo ""
    echo "Options:"
    echo "  --all           Show all conversation threads"
    echo "  <search_term>   Show specific thread by message ID or title"
    echo ""
    echo "Examples:"
    echo "  $0 --all"
    echo "  $0 2025-10-09T06:35:00"
    echo "  $0 'Framework Update'"
    exit 1
}

# Main
main() {
    if [ $# -eq 0 ]; then
        usage
    fi

    case "$1" in
        --all)
            list_all_threads
            ;;
        --help|-h)
            usage
            ;;
        *)
            show_thread "$1"
            ;;
    esac
}

main "$@"
