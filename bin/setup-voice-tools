#!/bin/bash
# setup-voice-tools - One-time setup for voice workflow tools
# Adds ~/bin to PATH and verifies installation

set -euo pipefail

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

ZSHRC="${HOME}/.zshrc"
BIN_DIR="${HOME}/bin"

echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo -e "${BLUE}   Voice Workflow Tools Setup${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo ""

# Step 1: Check ~/bin exists
echo -e "${BLUE}[1/4] Checking ~/bin directory...${NC}"
if [[ -d "$BIN_DIR" ]]; then
    echo -e "  ${GREEN}✓${NC} ~/bin exists"
else
    echo -e "  ${RED}✗${NC} ~/bin not found"
    echo -e "  Creating ~/bin..."
    mkdir -p "$BIN_DIR"
    echo -e "  ${GREEN}✓${NC} Created ~/bin"
fi
echo ""

# Step 2: Add ~/bin to PATH in .zshrc
echo -e "${BLUE}[2/4] Adding ~/bin to PATH...${NC}"

if /usr/bin/grep -q "export PATH=\"\$HOME/bin:\$PATH\"" "$ZSHRC" 2>/dev/null; then
    echo -e "  ${YELLOW}⚠${NC} ~/bin already in .zshrc"
else
    # Add to .zshrc
    cat >> "$ZSHRC" <<'EOF'

# Add ~/bin to PATH for user scripts
export PATH="$HOME/bin:$PATH"
EOF
    echo -e "  ${GREEN}✓${NC} Added ~/bin to .zshrc"
fi

# Also add to current session
export PATH="$HOME/bin:$PATH"
echo -e "  ${GREEN}✓${NC} Added ~/bin to current session"
echo ""

# Step 3: Verify tools are accessible
echo -e "${BLUE}[3/4] Verifying tool installation...${NC}"

TOOLS=(
    "ask-claude"
    "voice-bridge"
    "voice-note"
    "voice-dict-helper"
    "claude-status"
    "claude-workflow"
    "save-to-desktop"
)

ALL_OK=true
for tool in "${TOOLS[@]}"; do
    if [[ -x "$BIN_DIR/$tool" ]]; then
        echo -e "  ${GREEN}✓${NC} $tool"
    else
        echo -e "  ${RED}✗${NC} $tool missing or not executable"
        ALL_OK=false
    fi
done
echo ""

# Step 4: Test a command
echo -e "${BLUE}[4/4] Testing command execution...${NC}"
if command -v voice-dict-helper >/dev/null 2>&1; then
    echo -e "  ${GREEN}✓${NC} Commands are accessible"
else
    echo -e "  ${YELLOW}⚠${NC} Commands not yet in PATH for this shell"
    echo -e "  ${CYAN}Run:${NC} source ~/.zshrc"
fi
echo ""

# Summary
echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
if [[ "$ALL_OK" == true ]]; then
    echo -e "${GREEN}✓ Setup Complete!${NC}"
    echo ""
    echo -e "${CYAN}Next Steps:${NC}"
    echo -e "  1. Run: ${GREEN}source ~/.zshrc${NC} (to activate in current shell)"
    echo -e "  2. Run: ${GREEN}voice-dict-helper setup${NC} (configure voice recognition)"
    echo -e "  3. Run: ${GREEN}claude-status${NC} (see your dashboard)"
    echo ""
    echo -e "${YELLOW}Note:${NC} New terminal windows will automatically have ~/bin in PATH"
else
    echo -e "${RED}! Setup incomplete - some tools missing${NC}"
    echo -e "  Check ~/bin/ directory for missing files"
fi
echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo ""
