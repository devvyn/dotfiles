#!/bin/bash
# Interactive Message Composer for Bridge
# Creates messages in drafts folder with optional immediate sending

set -euo pipefail

WORKSPACE_ROOT="/Users/devvynmurphy/infrastructure/agent-bridge/workspace"
DRAFTS_DIR="$WORKSPACE_ROOT/drafts"
TEMPLATES_DIR="$WORKSPACE_ROOT/templates"
BRIDGE_ROOT="/Users/devvynmurphy/infrastructure/agent-bridge/bridge"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print colored message
print_color() {
    local color=$1
    shift
    echo -e "${color}$*${NC}"
}

# Get registered agents
get_agents() {
    if [ -f "$BRIDGE_ROOT/registry/agents.json" ]; then
        jq -r '.active_agents | keys[]' "$BRIDGE_ROOT/registry/agents.json" 2>/dev/null || echo "code chat human investigator hopper"
    else
        echo "code chat human investigator hopper"
    fi
}

# List available templates
list_templates() {
    if [ -d "$TEMPLATES_DIR" ] && [ "$(ls -A "$TEMPLATES_DIR" 2>/dev/null)" ]; then
        ls "$TEMPLATES_DIR"/*.md 2>/dev/null | xargs -n 1 basename | sed 's/.md$//' || echo ""
    else
        echo ""
    fi
}

# Interactive prompts
prompt_with_default() {
    local prompt=$1
    local default=$2
    local value

    if [ -n "$default" ]; then
        read -p "$(print_color "$BLUE" "$prompt [$default]: ")" value
        echo "${value:-$default}"
    else
        read -p "$(print_color "$BLUE" "$prompt: ")" value
        echo "$value"
    fi
}

# Main composition flow
main() {
    print_color "$GREEN" "=== Bridge Message Composer ==="
    echo ""

    # Get agents list
    AGENTS=$(get_agents)
    print_color "$YELLOW" "Available agents: $AGENTS"
    echo ""

    # Prompt for message details
    SENDER=$(prompt_with_default "From (sender agent)" "code")
    RECIPIENT=$(prompt_with_default "To (recipient agent)" "chat")

    echo ""
    print_color "$YELLOW" "Priorities: CRITICAL | HIGH | NORMAL | INFO"
    PRIORITY=$(prompt_with_default "Priority" "NORMAL")
    PRIORITY=$(echo "$PRIORITY" | tr '[:lower:]' '[:upper:]')

    echo ""
    read -p "$(print_color "$BLUE" "Message title: ")" TITLE

    # Check for templates
    echo ""
    TEMPLATES=$(list_templates)
    if [ -n "$TEMPLATES" ]; then
        print_color "$YELLOW" "Available templates:"
        echo "$TEMPLATES" | nl -w2 -s') '
        echo ""
        read -p "$(print_color "$BLUE" "Use template? (number or Enter to skip): ")" TEMPLATE_CHOICE

        if [ -n "$TEMPLATE_CHOICE" ] && [ "$TEMPLATE_CHOICE" -gt 0 ] 2>/dev/null; then
            TEMPLATE_FILE=$(echo "$TEMPLATES" | sed -n "${TEMPLATE_CHOICE}p")
            if [ -n "$TEMPLATE_FILE" ]; then
                TEMPLATE_PATH="$TEMPLATES_DIR/${TEMPLATE_FILE}.md"
                print_color "$GREEN" "Using template: $TEMPLATE_FILE"
            fi
        fi
    fi

    # Create draft file
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    DRAFT_FILENAME="${TIMESTAMP}-${SENDER}-to-${RECIPIENT}.md"
    DRAFT_PATH="$DRAFTS_DIR/$SENDER/$DRAFT_FILENAME"

    # Ensure drafts directory exists
    mkdir -p "$DRAFTS_DIR/$SENDER"

    # Create message from template or blank
    if [ -n "${TEMPLATE_PATH:-}" ] && [ -f "$TEMPLATE_PATH" ]; then
        cp "$TEMPLATE_PATH" "$DRAFT_PATH"
    else
        cat > "$DRAFT_PATH" <<EOF
# [PRIORITY: $PRIORITY] $TITLE

**From**: $SENDER
**To**: $RECIPIENT
**Timestamp**: $(date -Iseconds)

## Context

[Explain why this message matters and what led to it]

## Content

[Main message content goes here]

## Expected Action

[What should the recipient do with this information?]
EOF
    fi

    print_color "$GREEN" "Draft created: $DRAFT_PATH"
    echo ""

    # Open in editor
    read -p "$(print_color "$BLUE" "Open in editor? (Y/n): ")" OPEN_EDITOR
    OPEN_EDITOR=${OPEN_EDITOR:-Y}

    if [[ "$OPEN_EDITOR" =~ ^[Yy] ]]; then
        ${EDITOR:-vim} "$DRAFT_PATH"
    fi

    echo ""
    print_color "$YELLOW" "Message saved to: $DRAFT_PATH"

    # Option to send immediately
    echo ""
    read -p "$(print_color "$BLUE" "Send message now? (y/N): ")" SEND_NOW

    if [[ "$SEND_NOW" =~ ^[Yy] ]]; then
        print_color "$YELLOW" "Sending message..."

        # Use universal send script
        SEND_SCRIPT="$WORKSPACE_ROOT/scripts/bridge-send-universal.sh"
        if [ -x "$SEND_SCRIPT" ]; then
            "$SEND_SCRIPT" "$SENDER" "$RECIPIENT" "$PRIORITY" "$TITLE" "$DRAFT_PATH"
            print_color "$GREEN" "Message sent successfully!"
        else
            # Fallback to direct script
            /Users/devvynmurphy/devvyn-meta-project/scripts/bridge-send.sh \
                "$SENDER" "$RECIPIENT" "$PRIORITY" "$TITLE" "$DRAFT_PATH"
            print_color "$GREEN" "Message sent successfully!"
        fi

        # Archive the draft
        ARCHIVE_DIR="$DRAFTS_DIR/$SENDER/sent"
        mkdir -p "$ARCHIVE_DIR"
        mv "$DRAFT_PATH" "$ARCHIVE_DIR/"
        print_color "$YELLOW" "Draft archived to: $ARCHIVE_DIR/"
    else
        print_color "$YELLOW" "Message saved as draft. Send later with:"
        echo "  $WORKSPACE_ROOT/scripts/send-draft.sh $DRAFT_PATH"
    fi

    echo ""
    print_color "$GREEN" "Done!"
}

main "$@"
